# Cloud Build configuration for Chatbot deployment
steps:
  # Build agent registry image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-registry'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/agent-registry:$BUILD_ID'
      - '-t'
      - 'gcr.io/$PROJECT_ID/agent-registry:latest'
      - '-f'
      - 'deploy/Dockerfile.registry'
      - '.'

  # Push registry image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-registry'
    args:
      - 'push'
      - '--all-tags'
      - 'gcr.io/$PROJECT_ID/agent-registry'
    waitFor: ['build-registry']

  # Deploy agent registry to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-registry'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'agent-registry'
      - '--image=gcr.io/$PROJECT_ID/agent-registry:latest'
      - '--platform=managed'
      - '--region=$_REGION'
      - '--allow-unauthenticated'
      - '--memory=512Mi'
      - '--cpu=1'
      - '--timeout=60'
      - '--max-instances=10'
      - '--min-instances=0'
    waitFor: ['push-registry']

  # Build chatbot image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-chatbot'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/stock-chatbot:$BUILD_ID'
      - '-t'
      - 'gcr.io/$PROJECT_ID/stock-chatbot:latest'
      - '-f'
      - 'deploy/Dockerfile.chatbot'
      - '.'

  # Push chatbot image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-chatbot'
    args:
      - 'push'
      - '--all-tags'
      - 'gcr.io/$PROJECT_ID/stock-chatbot'
    waitFor: ['build-chatbot']

  # Get agent URLs and deploy chatbot
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-chatbot'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        FUNDAMENTAL_URL=$$(gcloud run services describe fundamental-agent --region=${_REGION} --format='value(status.url)')
        TECHNICAL_URL=$$(gcloud run services describe technical-agent --region=${_REGION} --format='value(status.url)')
        SENTIMENT_URL=$$(gcloud run services describe sentiment-agent --region=${_REGION} --format='value(status.url)')
        MACRO_URL=$$(gcloud run services describe macro-agent --region=${_REGION} --format='value(status.url)')
        REGULATORY_URL=$$(gcloud run services describe regulatory-agent --region=${_REGION} --format='value(status.url)')
        PREDICTOR_URL=$$(gcloud run services describe predictor-agent --region=${_REGION} --format='value(status.url)')
        REGISTRY_URL=$$(gcloud run services describe agent-registry --region=${_REGION} --format='value(status.url)')
        
        # Delete existing service if it has conflicting config, then recreate
        if gcloud run services describe stock-chatbot --region=${_REGION} --project=${PROJECT_ID} &>/dev/null; then
          echo "Deleting existing service to fix configuration conflict..."
          gcloud run services delete stock-chatbot --region=${_REGION} --project=${PROJECT_ID} --quiet || true
          sleep 5
        fi
        
        # Create new service with correct configuration
        gcloud run deploy stock-chatbot \
          --image=gcr.io/${PROJECT_ID}/stock-chatbot:latest \
          --platform=managed \
          --region=${_REGION} \
          --allow-unauthenticated \
          --set-env-vars="FUNDAMENTAL_AGENT_URL=$${FUNDAMENTAL_URL},TECHNICAL_AGENT_URL=$${TECHNICAL_URL},SENTIMENT_AGENT_URL=$${SENTIMENT_URL},MACRO_AGENT_URL=$${MACRO_URL},REGULATORY_AGENT_URL=$${REGULATORY_URL},PREDICTOR_AGENT_URL=$${PREDICTOR_URL},AGENT_REGISTRY_URL=$${REGISTRY_URL}" \
          --set-secrets="GOOGLE_API_KEY=GOOGLE_API_KEY:latest" \
          --memory=2Gi \
          --cpu=2 \
          --timeout=600 \
          --max-instances=20 \
          --min-instances=1
    secretEnv: ['GOOGLE_API_KEY']
    waitFor: ['push-chatbot', 'deploy-registry']

substitutions:
  _REGION: us-central1

options:
  logging: CLOUD_LOGGING_ONLY

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/GOOGLE_API_KEY/versions/latest
      env: 'GOOGLE_API_KEY'
